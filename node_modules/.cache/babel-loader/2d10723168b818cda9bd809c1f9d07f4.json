{"ast":null,"code":"const log = require('npmlog');\n\nconst npa = require('npm-package-arg');\n\nconst npmFetch = require('npm-registry-fetch');\n\nconst pacote = require('pacote');\n\nconst otplease = require('./utils/otplease.js');\n\nconst readLocalPkg = require('./utils/read-local-package.js');\n\nconst BaseCommand = require('./base-command.js');\n\nclass Owner extends BaseCommand {\n  static get description() {\n    return 'Manage package owners';\n  }\n  /* istanbul ignore next - see test/lib/load-all-commands.js */\n\n\n  static get name() {\n    return 'owner';\n  }\n  /* istanbul ignore next - see test/lib/load-all-commands.js */\n\n\n  static get usage() {\n    return ['add <user> [<@scope>/]<pkg>', 'rm <user> [<@scope>/]<pkg>', 'ls [<@scope>/]<pkg>'];\n  }\n\n  async completion(opts) {\n    const argv = opts.conf.argv.remain;\n    if (argv.length > 3) return [];\n    if (argv[1] !== 'owner') argv.unshift('owner');\n    if (argv.length === 2) return ['add', 'rm', 'ls']; // reaches registry in order to autocomplete rm\n\n    if (argv[2] === 'rm') {\n      const pkgName = await readLocalPkg(this.npm);\n      if (!pkgName) return [];\n      const spec = npa(pkgName);\n      const data = await pacote.packument(spec, { ...this.npm.flatOptions,\n        fullMetadata: true\n      });\n      if (data && data.maintainers && data.maintainers.length) return data.maintainers.map(m => m.name);\n    }\n\n    return [];\n  }\n\n  exec(args, cb) {\n    this.owner(args).then(() => cb()).catch(cb);\n  }\n\n  async owner([action, ...args]) {\n    const opts = this.npm.flatOptions;\n\n    switch (action) {\n      case 'ls':\n      case 'list':\n        return this.ls(args[0], opts);\n\n      case 'add':\n        return this.add(args[0], args[1], opts);\n\n      case 'rm':\n      case 'remove':\n        return this.rm(args[0], args[1], opts);\n\n      default:\n        throw this.usageError();\n    }\n  }\n\n  async ls(pkg, opts) {\n    if (!pkg) {\n      const pkgName = await readLocalPkg(this.npm);\n      if (!pkgName) throw this.usageError();\n      pkg = pkgName;\n    }\n\n    const spec = npa(pkg);\n\n    try {\n      const packumentOpts = { ...opts,\n        fullMetadata: true\n      };\n      const {\n        maintainers\n      } = await pacote.packument(spec, packumentOpts);\n      if (!maintainers || !maintainers.length) this.npm.output('no admin found');else this.npm.output(maintainers.map(o => `${o.name} <${o.email}>`).join('\\n'));\n      return maintainers;\n    } catch (err) {\n      log.error('owner ls', \"Couldn't get owner data\", pkg);\n      throw err;\n    }\n  }\n\n  async add(user, pkg, opts) {\n    if (!user) throw this.usageError();\n\n    if (!pkg) {\n      const pkgName = await readLocalPkg(this.npm);\n      if (!pkgName) throw this.usageError();\n      pkg = pkgName;\n    }\n\n    log.verbose('owner add', '%s to %s', user, pkg);\n    const spec = npa(pkg);\n    return this.putOwners(spec, user, opts, (newOwner, owners) => this.validateAddOwner(newOwner, owners));\n  }\n\n  async rm(user, pkg, opts) {\n    if (!user) throw this.usageError();\n\n    if (!pkg) {\n      const pkgName = await readLocalPkg(this.npm);\n      if (!pkgName) throw this.usageError();\n      pkg = pkgName;\n    }\n\n    log.verbose('owner rm', '%s from %s', user, pkg);\n    const spec = npa(pkg);\n    return this.putOwners(spec, user, opts, (rmOwner, owners) => this.validateRmOwner(rmOwner, owners));\n  }\n\n  async putOwners(spec, user, opts, validation) {\n    const uri = `/-/user/org.couchdb.user:${encodeURIComponent(user)}`;\n    let u = '';\n\n    try {\n      u = await npmFetch.json(uri, opts);\n    } catch (err) {\n      log.error('owner mutate', `Error getting user data for ${user}`);\n      throw err;\n    }\n\n    if (user && (!u || !u.name || u.error)) {\n      throw Object.assign(new Error(\"Couldn't get user data for \" + user + ': ' + JSON.stringify(u)), {\n        code: 'EOWNERUSER'\n      });\n    } // normalize user data\n\n\n    u = {\n      name: u.name,\n      email: u.email\n    };\n    const data = await pacote.packument(spec, { ...opts,\n      fullMetadata: true\n    }); // save the number of maintainers before validation for comparison\n\n    const before = data.maintainers ? data.maintainers.length : 0;\n    const m = validation(u, data.maintainers);\n    if (!m) return; // invalid owners\n\n    const body = {\n      _id: data._id,\n      _rev: data._rev,\n      maintainers: m\n    };\n    const dataPath = `/${spec.escapedName}/-rev/${encodeURIComponent(data._rev)}`;\n    const res = await otplease(opts, opts => {\n      return npmFetch.json(dataPath, { ...opts,\n        method: 'PUT',\n        body,\n        spec\n      });\n    });\n\n    if (!res.error) {\n      if (m.length < before) this.npm.output(`- ${user} (${spec.name})`);else this.npm.output(`+ ${user} (${spec.name})`);\n    } else {\n      throw Object.assign(new Error('Failed to update package: ' + JSON.stringify(res)), {\n        code: 'EOWNERMUTATE'\n      });\n    }\n\n    return res;\n  }\n\n  validateAddOwner(newOwner, owners) {\n    owners = owners || [];\n\n    for (const o of owners) {\n      if (o.name === newOwner.name) {\n        log.info('owner add', 'Already a package owner: ' + o.name + ' <' + o.email + '>');\n        return false;\n      }\n    }\n\n    return [...owners, newOwner];\n  }\n\n  validateRmOwner(rmOwner, owners) {\n    let found = false;\n    const m = owners.filter(function (o) {\n      var match = o.name === rmOwner.name;\n      found = found || match;\n      return !match;\n    });\n\n    if (!found) {\n      log.info('owner rm', 'Not a package owner: ' + rmOwner.name);\n      return false;\n    }\n\n    if (!m.length) {\n      throw Object.assign(new Error('Cannot remove all owners of a package. Add someone else first.'), {\n        code: 'EOWNERRM'\n      });\n    }\n\n    return m;\n  }\n\n}\n\nmodule.exports = Owner;","map":{"version":3,"sources":["/Users/kaelen/nsc-mds/node_modules/npm/lib/owner.js"],"names":["log","require","npa","npmFetch","pacote","otplease","readLocalPkg","BaseCommand","Owner","description","name","usage","completion","opts","argv","conf","remain","length","unshift","pkgName","npm","spec","data","packument","flatOptions","fullMetadata","maintainers","map","m","exec","args","cb","owner","then","catch","action","ls","add","rm","usageError","pkg","packumentOpts","output","o","email","join","err","error","user","verbose","putOwners","newOwner","owners","validateAddOwner","rmOwner","validateRmOwner","validation","uri","encodeURIComponent","u","json","Object","assign","Error","JSON","stringify","code","before","body","_id","_rev","dataPath","escapedName","res","method","info","found","filter","match","module","exports"],"mappings":"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","sourcesContent":["const log = require('npmlog')\nconst npa = require('npm-package-arg')\nconst npmFetch = require('npm-registry-fetch')\nconst pacote = require('pacote')\n\nconst otplease = require('./utils/otplease.js')\nconst readLocalPkg = require('./utils/read-local-package.js')\nconst BaseCommand = require('./base-command.js')\n\nclass Owner extends BaseCommand {\n  static get description () {\n    return 'Manage package owners'\n  }\n\n  /* istanbul ignore next - see test/lib/load-all-commands.js */\n  static get name () {\n    return 'owner'\n  }\n\n  /* istanbul ignore next - see test/lib/load-all-commands.js */\n  static get usage () {\n    return [\n      'add <user> [<@scope>/]<pkg>',\n      'rm <user> [<@scope>/]<pkg>',\n      'ls [<@scope>/]<pkg>',\n    ]\n  }\n\n  async completion (opts) {\n    const argv = opts.conf.argv.remain\n    if (argv.length > 3)\n      return []\n\n    if (argv[1] !== 'owner')\n      argv.unshift('owner')\n\n    if (argv.length === 2)\n      return ['add', 'rm', 'ls']\n\n    // reaches registry in order to autocomplete rm\n    if (argv[2] === 'rm') {\n      const pkgName = await readLocalPkg(this.npm)\n      if (!pkgName)\n        return []\n\n      const spec = npa(pkgName)\n      const data = await pacote.packument(spec, {\n        ...this.npm.flatOptions,\n        fullMetadata: true,\n      })\n      if (data && data.maintainers && data.maintainers.length)\n        return data.maintainers.map(m => m.name)\n    }\n    return []\n  }\n\n  exec (args, cb) {\n    this.owner(args).then(() => cb()).catch(cb)\n  }\n\n  async owner ([action, ...args]) {\n    const opts = this.npm.flatOptions\n    switch (action) {\n      case 'ls':\n      case 'list':\n        return this.ls(args[0], opts)\n      case 'add':\n        return this.add(args[0], args[1], opts)\n      case 'rm':\n      case 'remove':\n        return this.rm(args[0], args[1], opts)\n      default:\n        throw this.usageError()\n    }\n  }\n\n  async ls (pkg, opts) {\n    if (!pkg) {\n      const pkgName = await readLocalPkg(this.npm)\n      if (!pkgName)\n        throw this.usageError()\n\n      pkg = pkgName\n    }\n\n    const spec = npa(pkg)\n\n    try {\n      const packumentOpts = { ...opts, fullMetadata: true }\n      const { maintainers } = await pacote.packument(spec, packumentOpts)\n      if (!maintainers || !maintainers.length)\n        this.npm.output('no admin found')\n      else\n        this.npm.output(maintainers.map(o => `${o.name} <${o.email}>`).join('\\n'))\n\n      return maintainers\n    } catch (err) {\n      log.error('owner ls', \"Couldn't get owner data\", pkg)\n      throw err\n    }\n  }\n\n  async add (user, pkg, opts) {\n    if (!user)\n      throw this.usageError()\n\n    if (!pkg) {\n      const pkgName = await readLocalPkg(this.npm)\n      if (!pkgName)\n        throw this.usageError()\n\n      pkg = pkgName\n    }\n    log.verbose('owner add', '%s to %s', user, pkg)\n\n    const spec = npa(pkg)\n    return this.putOwners(spec, user, opts,\n      (newOwner, owners) => this.validateAddOwner(newOwner, owners))\n  }\n\n  async rm (user, pkg, opts) {\n    if (!user)\n      throw this.usageError()\n\n    if (!pkg) {\n      const pkgName = await readLocalPkg(this.npm)\n      if (!pkgName)\n        throw this.usageError()\n\n      pkg = pkgName\n    }\n    log.verbose('owner rm', '%s from %s', user, pkg)\n\n    const spec = npa(pkg)\n    return this.putOwners(spec, user, opts,\n      (rmOwner, owners) => this.validateRmOwner(rmOwner, owners))\n  }\n\n  async putOwners (spec, user, opts, validation) {\n    const uri = `/-/user/org.couchdb.user:${encodeURIComponent(user)}`\n    let u = ''\n\n    try {\n      u = await npmFetch.json(uri, opts)\n    } catch (err) {\n      log.error('owner mutate', `Error getting user data for ${user}`)\n      throw err\n    }\n\n    if (user && (!u || !u.name || u.error)) {\n      throw Object.assign(\n        new Error(\n          \"Couldn't get user data for \" + user + ': ' + JSON.stringify(u)\n        ),\n        { code: 'EOWNERUSER' }\n      )\n    }\n\n    // normalize user data\n    u = { name: u.name, email: u.email }\n\n    const data = await pacote.packument(spec, { ...opts, fullMetadata: true })\n\n    // save the number of maintainers before validation for comparison\n    const before = data.maintainers ? data.maintainers.length : 0\n\n    const m = validation(u, data.maintainers)\n    if (!m)\n      return // invalid owners\n\n    const body = {\n      _id: data._id,\n      _rev: data._rev,\n      maintainers: m,\n    }\n    const dataPath = `/${spec.escapedName}/-rev/${encodeURIComponent(data._rev)}`\n    const res = await otplease(opts, opts => {\n      return npmFetch.json(dataPath, {\n        ...opts,\n        method: 'PUT',\n        body,\n        spec,\n      })\n    })\n\n    if (!res.error) {\n      if (m.length < before)\n        this.npm.output(`- ${user} (${spec.name})`)\n      else\n        this.npm.output(`+ ${user} (${spec.name})`)\n    } else {\n      throw Object.assign(\n        new Error('Failed to update package: ' + JSON.stringify(res)),\n        { code: 'EOWNERMUTATE' }\n      )\n    }\n    return res\n  }\n\n  validateAddOwner (newOwner, owners) {\n    owners = owners || []\n    for (const o of owners) {\n      if (o.name === newOwner.name) {\n        log.info(\n          'owner add',\n          'Already a package owner: ' + o.name + ' <' + o.email + '>'\n        )\n        return false\n      }\n    }\n    return [\n      ...owners,\n      newOwner,\n    ]\n  }\n\n  validateRmOwner (rmOwner, owners) {\n    let found = false\n    const m = owners.filter(function (o) {\n      var match = (o.name === rmOwner.name)\n      found = found || match\n      return !match\n    })\n\n    if (!found) {\n      log.info('owner rm', 'Not a package owner: ' + rmOwner.name)\n      return false\n    }\n\n    if (!m.length) {\n      throw Object.assign(\n        new Error(\n          'Cannot remove all owners of a package. Add someone else first.'\n        ),\n        { code: 'EOWNERRM' }\n      )\n    }\n\n    return m\n  }\n}\nmodule.exports = Owner\n"]},"metadata":{},"sourceType":"script"}